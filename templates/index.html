<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ìˆ˜ì–´ ì˜ˆì¸¡ ì‹œìŠ¤í…œ</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        background-color: #f5f5f5;
        margin: 0;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      #video {
        border: 1px solid #000;
        margin-bottom: 20px;
      }
      .output {
        font-size: 1.2em;
        margin: 15px 0;
      }
      button {
        padding: 10px 20px;
        font-size: 1em;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§  ìˆ˜ì–´ ì˜ˆì¸¡ ì‹œìŠ¤í…œ</h1>

    <!-- ì›¹ìº  ìŠ¤íŠ¸ë¦¬ë° -->
    <img id="video" src="/video_feed" width="480" height="360" alt="Webcam Stream" />

    <!-- ì˜ˆì¸¡ëœ ë‹¨ì–´ë“¤ì„ ë‚˜ì—´ -->
    <p class="output">
      <strong>ì˜ˆì¸¡ëœ ë‹¨ì–´ë“¤:</strong>
      <span id="predictedWords">-</span>
    </p>

    <!-- ë¬¸ì¥ ìƒì„± ë²„íŠ¼ -->
    <button id="genSentenceBtn">ë¬¸ì¥ ìƒì„±</button>

    <!-- ìƒì„±ëœ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ ì¶œë ¥ -->
    <p class="output">
      <strong>ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥:</strong>
      <span id="sentence">-</span>
    </p>

    <script>
      let keywordInterval = null;
      let previousKeywords = "";  // ì´ì „ ë‹¨ì–´ ì €ì¥

      // í‚¤ì›Œë“œ í´ë§ í•¨ìˆ˜
      function startFetchingKeywords() {
        keywordInterval = setInterval(() => {
          fetch("/keywords")
            .then((res) => res.json())
            .then((data) => {
              // ì˜ˆì¸¡ëœ ë‹¨ì–´ê°€ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
              const newKeywords = data.keywords || "-";
              if (newKeywords !== previousKeywords) {
                document.getElementById("predictedWords").innerText = newKeywords;
                previousKeywords = newKeywords;
              }
            })
            .catch((err) => console.error("Error fetching keywords:", err));
        }, 3000);
      }

      function stopFetchingKeywords() {
        if (keywordInterval) {
          clearInterval(keywordInterval);
          keywordInterval = null;
        }
      }

      // ë¬¸ì¥ ìƒì„± ë²„íŠ¼ í•¸ë“¤ëŸ¬
      document.getElementById("genSentenceBtn").addEventListener("click", () => {
        const words = document.getElementById("predictedWords").innerText;
        if (!words || words.trim() === "-" || words.trim() === "") {
          alert("ì˜ˆì¸¡ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // í‚¤ì›Œë“œ ê°±ì‹  ì¤‘ë‹¨
        stopFetchingKeywords();

        // ë¬¸ì¥ ìƒì„± ìš”ì²­
        fetch(`/gen_sentence?word=${encodeURIComponent(words)}`)
          .then((res) => res.json())
          .then((data) => {
            // ìƒì„±ëœ ë¬¸ì¥ ì—…ë°ì´íŠ¸
            document.getElementById("sentence").innerText = data.sentence;

            // ìŒì„± ì¶œë ¥ (ko-KR)
            const utter = new SpeechSynthesisUtterance(data.sentence);
            utter.lang = "ko-KR";
            speechSynthesis.speak(utter);

            // ì˜ˆì¸¡ ë‹¨ì–´ ì˜ì—­ ì´ˆê¸°í™” (ì¦‰ì‹œ UIìƒ í‘œì‹œ ì œê±°)
            document.getElementById("predictedWords").innerText = "-";
            previousKeywords = "-";

            // í‚¤ì›Œë“œ í´ë§ ì¬ì‹œì‘
            startFetchingKeywords();
          })
          .catch((err) => {
            console.error("Error generating sentence:", err);
            startFetchingKeywords();
          });
      });

      // ì´ˆê¸° í‚¤ì›Œë“œ í´ë§ ì‹œì‘
      startFetchingKeywords();
    </script>
  </body>
</html>
